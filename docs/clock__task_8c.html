<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.16.1"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Solari Cifra 5 Firmware: clock_task.c File Reference</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<script type="text/javascript" src="clipboard.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript" src="cookie.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectalign">
   <div id="projectname">Solari Cifra 5 Firmware<span id="projectnumber">&#160;2.0</span>
   </div>
   <div id="projectbrief">STM32G031K8 FreeRTOS firmware for Solari Cifra 5 mechanical flip clock</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.16.1 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search/",'.html');
</script>
<script type="text/javascript">
$(function() { codefold.init(); });
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
$(function() {
  initMenu('',true,false,'search.php','Search',true);
  $(function() { init_search(); });
});
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(function(){initNavTree('clock__task_8c.html','',''); });
</script>
<div id="container">
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div class="header">
  <div class="headertitle"><div class="title">clock_task.c File Reference</div></div>
</div><!--header-->
<div class="contents">

<p>Mechanical clock synchronization and minute ticking task.  
<a href="#details">More...</a></p>
<div class="textblock"><code>#include &quot;<a class="el" href="rtos__init_8h_source.html">rtos_init.h</a>&quot;</code><br />
<code>#include &quot;<a class="el" href="rtc__helpers_8h_source.html">rtc_helpers.h</a>&quot;</code><br />
<code>#include &quot;<a class="el" href="clock__task_8h_source.html">clock_task.h</a>&quot;</code><br />
</div>
<p><a href="clock__task_8c_source.html">Go to the source code of this file.</a></p>
<table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 id="header-func-members" class="groupheader"><a id="func-members" name="func-members"></a>
Functions</h2></td></tr>
<tr class="memitem:a0c9c416c41e84051891b7174b8f69652" id="r_a0c9c416c41e84051891b7174b8f69652"><td class="memItemLeft">static void&#160;</td><td class="memItemRight"><a class="el" href="#a0c9c416c41e84051891b7174b8f69652">prepareServo</a> (void)</td></tr>
<tr class="memdesc:a0c9c416c41e84051891b7174b8f69652"><td class="mdescLeft">&#160;</td><td class="mdescRight">Initialize servo PWM and move to release (neutral) position.  <br /></td></tr>
<tr class="memitem:a6c2b9cd6274037ee74ba3c403dbf8a77" id="r_a6c2b9cd6274037ee74ba3c403dbf8a77"><td class="memItemLeft">static void&#160;</td><td class="memItemRight"><a class="el" href="#a6c2b9cd6274037ee74ba3c403dbf8a77">clockAdvHour</a> (void)</td></tr>
<tr class="memdesc:a6c2b9cd6274037ee74ba3c403dbf8a77"><td class="mdescLeft">&#160;</td><td class="mdescRight">Advance the mechanical hour flap by one position using the servo.  <br /></td></tr>
<tr class="memitem:aa4948a5d824e05cd5afa4014d3c7a572" id="r_aa4948a5d824e05cd5afa4014d3c7a572"><td class="memItemLeft">static void&#160;</td><td class="memItemRight"><a class="el" href="#aa4948a5d824e05cd5afa4014d3c7a572">shutdownServo</a> (void)</td></tr>
<tr class="memdesc:aa4948a5d824e05cd5afa4014d3c7a572"><td class="mdescLeft">&#160;</td><td class="mdescRight">Move servo to parking position and stop PWM output.  <br /></td></tr>
<tr class="memitem:a6b1b9a917b527b38d053ecab466a8982" id="r_a6b1b9a917b527b38d053ecab466a8982"><td class="memItemLeft">static void&#160;</td><td class="memItemRight"><a class="el" href="#a6b1b9a917b527b38d053ecab466a8982">clockAdvMinute</a> (const uint8_t slow)</td></tr>
<tr class="memdesc:a6b1b9a917b527b38d053ecab466a8982"><td class="mdescLeft">&#160;</td><td class="mdescRight">Advance the mechanical minute flap by one position using the coil.  <br /></td></tr>
<tr class="memitem:aeed11945d885a9995dff681eb17790b3" id="r_aeed11945d885a9995dff681eb17790b3"><td class="memItemLeft">static void&#160;</td><td class="memItemRight"><a class="el" href="#aeed11945d885a9995dff681eb17790b3">searchForZeroPosition</a> (void)</td></tr>
<tr class="memdesc:aeed11945d885a9995dff681eb17790b3"><td class="mdescLeft">&#160;</td><td class="mdescRight">Find the mechanical 00:00 position using physical sensors.  <br /></td></tr>
<tr class="memitem:a6694bba3c082a85d3e679a316b9f4ef1" id="r_a6694bba3c082a85d3e679a316b9f4ef1"><td class="memItemLeft">static void&#160;</td><td class="memItemRight"><a class="el" href="#a6694bba3c082a85d3e679a316b9f4ef1">syncHours</a> (uint8_t targetHours)</td></tr>
<tr class="memdesc:a6694bba3c082a85d3e679a316b9f4ef1"><td class="mdescLeft">&#160;</td><td class="mdescRight">Advance the hour flap to match the target RTC hour.  <br /></td></tr>
<tr class="memitem:a5d069d044f7414c2a339f7a7f6fa89aa" id="r_a5d069d044f7414c2a339f7a7f6fa89aa"><td class="memItemLeft">static void&#160;</td><td class="memItemRight"><a class="el" href="#a5d069d044f7414c2a339f7a7f6fa89aa">syncMinutes</a> (uint8_t targetMinutes)</td></tr>
<tr class="memdesc:a5d069d044f7414c2a339f7a7f6fa89aa"><td class="mdescLeft">&#160;</td><td class="mdescRight">Advance the minute flap to match the target RTC minutes.  <br /></td></tr>
<tr class="memitem:afe412f919f06588e8c7bb6f8316d7368" id="r_afe412f919f06588e8c7bb6f8316d7368"><td class="memItemLeft">static void&#160;</td><td class="memItemRight"><a class="el" href="#afe412f919f06588e8c7bb6f8316d7368">advanceToHourBoundary</a> (void)</td></tr>
<tr class="memdesc:afe412f919f06588e8c7bb6f8316d7368"><td class="mdescLeft">&#160;</td><td class="mdescRight">Advance minutes from current position to the next hour boundary (XX:00).  <br /></td></tr>
<tr class="memitem:ae45fd19b5c3a9bf7e848bb0ebcdbb43d" id="r_ae45fd19b5c3a9bf7e848bb0ebcdbb43d"><td class="memItemLeft">void&#160;</td><td class="memItemRight"><a class="el" href="#ae45fd19b5c3a9bf7e848bb0ebcdbb43d">clockTask</a> (void *parameters)</td></tr>
<tr class="memdesc:ae45fd19b5c3a9bf7e848bb0ebcdbb43d"><td class="mdescLeft">&#160;</td><td class="mdescRight">FreeRTOS task: mechanical clock synchronization and minute ticking.  <br /></td></tr>
</table>
<a name="details" id="details"></a><h2 id="header-details" class="groupheader">Detailed Description</h2>
<div class="textblock"><p>Mechanical clock synchronization and minute ticking task. </p>
<dl class="section version"><dt>Version</dt><dd>2.0 </dd></dl>
<dl class="section date"><dt>Date</dt><dd>12/02/2026 </dd></dl>
<dl class="section author"><dt>Author</dt><dd>Alfredo Cortellini</dd></dl>
<dl class="section copyright"><dt>Copyright</dt><dd>Copyright (c) 2026 Alfredo Cortellini. Licensed under CC BY-NC-SA 4.0. See <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/">https://creativecommons.org/licenses/by-nc-sa/4.0/</a> </dd></dl>

<p class="definition">Definition in file <a class="el" href="clock__task_8c_source.html">clock_task.c</a>.</p>
</div><a name="doc-func-members" id="doc-func-members"></a><h2 id="header-doc-func-members" class="groupheader">Function Documentation</h2>
<a id="a0c9c416c41e84051891b7174b8f69652" name="a0c9c416c41e84051891b7174b8f69652"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a0c9c416c41e84051891b7174b8f69652">&#9670;&#160;</a></span>prepareServo()</h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">void prepareServo </td>
          <td>(</td>
          <td class="paramtype">void</td>          <td class="paramname"><span class="paramname"><em></em></span></td><td>)</td>
          <td></td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel static">static</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p>Initialize servo PWM and move to release (neutral) position. </p>
<pre class="fragment">    Starts with CCR4=0 (servo off), enables PWM on TIM_CHANNEL_4,
    waits 200ms for the servo to power up, then sets the release
    position and waits for it to settle.

    The servo controls the hour flap advancement mechanism:
    - PARKING: arm retracted (off position)
    - RELEASE: arm at neutral (ready to engage)
    - ENGAGE:  arm pushes the flap forward by one step

    HAL_TIM_PWM_Start(htim, channel): starts PWM output on the
    specified timer channel. The duty cycle is set via CCR4 register.

    vTaskDelay(ticks): suspends the calling task for the specified
    number of ticks, yielding the CPU to other tasks. Unlike a busy
    wait, the task consumes no CPU time while delayed.
</pre> 
<p class="definition">Definition at line <a class="el" href="clock__task_8c_source.html#l00039">39</a> of file <a class="el" href="clock__task_8c_source.html">clock_task.c</a>.</p>

<p class="reference">References <a class="el" href="rtos__init_8c_source.html#l00025">htimHandle</a>, <a class="el" href="clock__task_8h_source.html#l00030">SERVO_PARK_TIME</a>, and <a class="el" href="clock__task_8h_source.html#l00027">SERVO_RELEASE_PWM</a>.</p>

<p class="reference">Referenced by <a class="el" href="clock__task_8c_source.html#l00173">searchForZeroPosition()</a>, and <a class="el" href="clock__task_8c_source.html#l00225">syncHours()</a>.</p>

</div>
</div>
<a id="a6c2b9cd6274037ee74ba3c403dbf8a77" name="a6c2b9cd6274037ee74ba3c403dbf8a77"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a6c2b9cd6274037ee74ba3c403dbf8a77">&#9670;&#160;</a></span>clockAdvHour()</h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">void clockAdvHour </td>
          <td>(</td>
          <td class="paramtype">void</td>          <td class="paramname"><span class="paramname"><em></em></span></td><td>)</td>
          <td></td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel static">static</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p>Advance the mechanical hour flap by one position using the servo. </p>
<pre class="fragment">    Performs one engage→release cycle: pushes the servo arm to the
    engage position (SERVO_ENGAGE_PWM) to flip one hour flap, then
    returns to the release position. Updates the mechanical hour
    counter in backup registers via incrementMechHour().

    The servo must be initialized with prepareServo() before calling.
    After all hour advances are done, call shutdownServo() to park.

    Guarded by CIFRA5_DEBUG: when defined, skips the physical servo
    movement but still updates the backup register (for testing).
</pre> 
<p class="definition">Definition at line <a class="el" href="clock__task_8c_source.html#l00063">63</a> of file <a class="el" href="clock__task_8c_source.html">clock_task.c</a>.</p>

<p class="reference">References <a class="el" href="rtos__init_8c_source.html#l00025">htimHandle</a>, <a class="el" href="rtc__helpers_8c_source.html#l00097">incrementMechHour()</a>, <a class="el" href="clock__task_8h_source.html#l00028">SERVO_ENGAGE_PWM</a>, <a class="el" href="clock__task_8h_source.html#l00029">SERVO_ENGAGE_TIME</a>, and <a class="el" href="clock__task_8h_source.html#l00027">SERVO_RELEASE_PWM</a>.</p>

<p class="reference">Referenced by <a class="el" href="clock__task_8c_source.html#l00173">searchForZeroPosition()</a>, and <a class="el" href="clock__task_8c_source.html#l00225">syncHours()</a>.</p>

</div>
</div>
<a id="aa4948a5d824e05cd5afa4014d3c7a572" name="aa4948a5d824e05cd5afa4014d3c7a572"></a>
<h2 class="memtitle"><span class="permalink"><a href="#aa4948a5d824e05cd5afa4014d3c7a572">&#9670;&#160;</a></span>shutdownServo()</h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">void shutdownServo </td>
          <td>(</td>
          <td class="paramtype">void</td>          <td class="paramname"><span class="paramname"><em></em></span></td><td>)</td>
          <td></td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel static">static</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p>Move servo to parking position and stop PWM output. </p>
<pre class="fragment">    Moves the servo arm to SERVO_PARKING_PWM (fully retracted),
    waits for it to settle, then sets CCR4=0 and stops the PWM
    timer to eliminate idle current draw from the servo.

    HAL_TIM_PWM_Stop(htim, channel): stops PWM generation on the
    timer channel. The output pin goes to its idle level.
</pre> 
<p class="definition">Definition at line <a class="el" href="clock__task_8c_source.html#l00087">87</a> of file <a class="el" href="clock__task_8c_source.html">clock_task.c</a>.</p>

<p class="reference">References <a class="el" href="rtos__init_8c_source.html#l00025">htimHandle</a>, <a class="el" href="clock__task_8h_source.html#l00030">SERVO_PARK_TIME</a>, and <a class="el" href="clock__task_8h_source.html#l00026">SERVO_PARKING_PWM</a>.</p>

<p class="reference">Referenced by <a class="el" href="clock__task_8c_source.html#l00173">searchForZeroPosition()</a>, and <a class="el" href="clock__task_8c_source.html#l00225">syncHours()</a>.</p>

</div>
</div>
<a id="a6b1b9a917b527b38d053ecab466a8982" name="a6b1b9a917b527b38d053ecab466a8982"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a6b1b9a917b527b38d053ecab466a8982">&#9670;&#160;</a></span>clockAdvMinute()</h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">void clockAdvMinute </td>
          <td>(</td>
          <td class="paramtype">const uint8_t</td>          <td class="paramname"><span class="paramname"><em>slow</em></span></td><td>)</td>
          <td></td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel static">static</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p>Advance the mechanical minute flap by one position using the coil. </p>
<pre class="fragment">    The minute mechanism uses an electromagnetic coil that alternates
    between two pins (tick/tock) on each advance. The alternation state
    is tracked in backup register DR2 bit 0 via getLastTick/setLastTick.

    Each pulse: drive the coil pin LOW (excite), wait coilExcite ms,
    then drive HIGH (release), wait coilRest ms. The slow parameter
    adds COIL_EXTRA_TIME to both durations for gentler movement during
    normal operation (vs. fast sync).

    After the pulse, updates the mechanical minute counter via
    incrementMechMinute() and saves the new tick state.

    HAL_GPIO_WritePin(port, pin, state): directly sets/clears a GPIO
    pin. GPIO_PIN_RESET=0 (coil energized), GPIO_PIN_SET=1 (coil off).

    Guarded by CIFRA5_DEBUG: when defined, skips physical GPIO
    toggling but still updates backup registers.
</pre><dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">slow</td><td>0 = fast (sync mode), 1 = slow (normal tick with extra delay) </td></tr>
  </table>
  </dd>
</dl>

<p class="definition">Definition at line <a class="el" href="clock__task_8c_source.html#l00118">118</a> of file <a class="el" href="clock__task_8c_source.html">clock_task.c</a>.</p>

<p class="reference">References <a class="el" href="main_8h_source.html#l00069">CLK_TICK_GPIO_Port</a>, <a class="el" href="main_8h_source.html#l00068">CLK_TICK_Pin</a>, <a class="el" href="main_8h_source.html#l00071">CLK_TOCK_GPIO_Port</a>, <a class="el" href="main_8h_source.html#l00070">CLK_TOCK_Pin</a>, <a class="el" href="clock__task_8h_source.html#l00034">COIL_EXCITE_TIME</a>, <a class="el" href="clock__task_8h_source.html#l00035">COIL_EXTRA_TIME</a>, <a class="el" href="clock__task_8h_source.html#l00033">COIL_REST_TIME</a>, <a class="el" href="rtc__helpers_8c_source.html#l00126">getLastTick()</a>, <a class="el" href="rtc__helpers_8c_source.html#l00074">incrementMechMinute()</a>, and <a class="el" href="rtc__helpers_8c_source.html#l00138">setLastTick()</a>.</p>

<p class="reference">Referenced by <a class="el" href="clock__task_8c_source.html#l00270">advanceToHourBoundary()</a>, <a class="el" href="clock__task_8c_source.html#l00322">clockTask()</a>, <a class="el" href="clock__task_8c_source.html#l00173">searchForZeroPosition()</a>, and <a class="el" href="clock__task_8c_source.html#l00249">syncMinutes()</a>.</p>

</div>
</div>
<a id="aeed11945d885a9995dff681eb17790b3" name="aeed11945d885a9995dff681eb17790b3"></a>
<h2 class="memtitle"><span class="permalink"><a href="#aeed11945d885a9995dff681eb17790b3">&#9670;&#160;</a></span>searchForZeroPosition()</h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">void searchForZeroPosition </td>
          <td>(</td>
          <td class="paramtype">void</td>          <td class="paramname"><span class="paramname"><em></em></span></td><td>)</td>
          <td></td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel static">static</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p>Find the mechanical 00:00 position using physical sensors. </p>
<pre class="fragment">    Called on first sync when the mechanical position is unknown (both
    mech hours and minutes are 0 in backup registers = not yet calibrated).

    Phase 1 — Find 00 minutes:
    Advances the minute flap until the hour sensor detects a 0→1
    transition (falling edge = magnet leaving sensor). This indicates
    the minutes have crossed an hour boundary (XX:00).
    Error after 62 attempts (&gt; 60 minutes = sensor missing).

    Phase 2 — Find 00 hours:
    Activates the servo, then advances the hour flap until the day
    sensor detects a 1→0 transition (rising edge = 24→00 rollover).
    Error after 25 attempts (&gt; 24 hours = sensor missing).

    On error, notifies displayTask with an error event and suspends.
    The task remains suspended until the user power-cycles the device.

    vTaskSuspend(NULL): suspends the calling task indefinitely.
    The task will not run again until another task calls
    vTaskResume(handle) on it. Passing NULL means "suspend myself".
</pre> 
<p class="definition">Definition at line <a class="el" href="clock__task_8c_source.html#l00173">173</a> of file <a class="el" href="clock__task_8c_source.html">clock_task.c</a>.</p>

<p class="reference">References <a class="el" href="clock__task_8c_source.html#l00063">clockAdvHour()</a>, <a class="el" href="clock__task_8c_source.html#l00118">clockAdvMinute()</a>, <a class="el" href="rtos__init_8h_source.html#l00046">DISP_EV_ERR_SNS_DAY</a>, <a class="el" href="rtos__init_8h_source.html#l00045">DISP_EV_ERR_SNS_HOUR</a>, <a class="el" href="rtos__init_8h_source.html#l00040">DISP_EV_SYN_SRC_DAY</a>, <a class="el" href="rtos__init_8h_source.html#l00039">DISP_EV_SYN_SRC_HOUR</a>, <a class="el" href="rtos__init_8c_source.html#l00027">displayTaskHandle</a>, <a class="el" href="clock__task_8c_source.html#l00039">prepareServo()</a>, <a class="el" href="rtc__helpers_8c_source.html#l00113">resetMechPosition()</a>, <a class="el" href="clock__task_8c_source.html#l00087">shutdownServo()</a>, <a class="el" href="main_8h_source.html#l00075">SNS_DAY_GPIO_Port</a>, <a class="el" href="main_8h_source.html#l00074">SNS_DAY_Pin</a>, <a class="el" href="main_8h_source.html#l00073">SNS_HOUR_GPIO_Port</a>, and <a class="el" href="main_8h_source.html#l00072">SNS_HOUR_Pin</a>.</p>

<p class="reference">Referenced by <a class="el" href="clock__task_8c_source.html#l00322">clockTask()</a>.</p>

</div>
</div>
<a id="a6694bba3c082a85d3e679a316b9f4ef1" name="a6694bba3c082a85d3e679a316b9f4ef1"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a6694bba3c082a85d3e679a316b9f4ef1">&#9670;&#160;</a></span>syncHours()</h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">void syncHours </td>
          <td>(</td>
          <td class="paramtype">uint8_t</td>          <td class="paramname"><span class="paramname"><em>targetHours</em></span></td><td>)</td>
          <td></td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel static">static</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p>Advance the hour flap to match the target RTC hour. </p>
<pre class="fragment">    If the servo is not already at release position, calls
    prepareServo() first (prevents double-initialization). Then
    loops clockAdvHour() until the mechanical hours (from backup
    registers) match targetHours. Finally parks the servo.

    Since hours wrap around 0-23, this handles any direction
    (e.g. mechanical=22, target=3 → advances 5 times through 0).
</pre><dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">targetHours</td><td>Desired hour position (0-23, from RTC) </td></tr>
  </table>
  </dd>
</dl>

<p class="definition">Definition at line <a class="el" href="clock__task_8c_source.html#l00225">225</a> of file <a class="el" href="clock__task_8c_source.html">clock_task.c</a>.</p>

<p class="reference">References <a class="el" href="clock__task_8c_source.html#l00063">clockAdvHour()</a>, <a class="el" href="rtos__init_8h_source.html#l00041">DISP_EV_SYN_SET_HOUR</a>, <a class="el" href="rtos__init_8c_source.html#l00027">displayTaskHandle</a>, <a class="el" href="rtc__helpers_8c_source.html#l00039">getMechHours()</a>, <a class="el" href="rtos__init_8c_source.html#l00025">htimHandle</a>, <a class="el" href="clock__task_8c_source.html#l00039">prepareServo()</a>, <a class="el" href="clock__task_8h_source.html#l00027">SERVO_RELEASE_PWM</a>, and <a class="el" href="clock__task_8c_source.html#l00087">shutdownServo()</a>.</p>

<p class="reference">Referenced by <a class="el" href="clock__task_8c_source.html#l00322">clockTask()</a>.</p>

</div>
</div>
<a id="a5d069d044f7414c2a339f7a7f6fa89aa" name="a5d069d044f7414c2a339f7a7f6fa89aa"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a5d069d044f7414c2a339f7a7f6fa89aa">&#9670;&#160;</a></span>syncMinutes()</h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">void syncMinutes </td>
          <td>(</td>
          <td class="paramtype">uint8_t</td>          <td class="paramname"><span class="paramname"><em>targetMinutes</em></span></td><td>)</td>
          <td></td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel static">static</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p>Advance the minute flap to match the target RTC minutes. </p>
<pre class="fragment">    Assumes the mechanical clock is at XX:00 (either from sensor
    search or advanceToHourBoundary). Advances targetMinutes times
    using fast coil pulses (slow=0).
</pre><dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">targetMinutes</td><td>Number of minute steps to advance (0-59, from RTC) </td></tr>
  </table>
  </dd>
</dl>

<p class="definition">Definition at line <a class="el" href="clock__task_8c_source.html#l00249">249</a> of file <a class="el" href="clock__task_8c_source.html">clock_task.c</a>.</p>

<p class="reference">References <a class="el" href="clock__task_8c_source.html#l00118">clockAdvMinute()</a>, <a class="el" href="rtos__init_8h_source.html#l00042">DISP_EV_SYN_SET_MIN</a>, and <a class="el" href="rtos__init_8c_source.html#l00027">displayTaskHandle</a>.</p>

<p class="reference">Referenced by <a class="el" href="clock__task_8c_source.html#l00322">clockTask()</a>.</p>

</div>
</div>
<a id="afe412f919f06588e8c7bb6f8316d7368" name="afe412f919f06588e8c7bb6f8316d7368"></a>
<h2 class="memtitle"><span class="permalink"><a href="#afe412f919f06588e8c7bb6f8316d7368">&#9670;&#160;</a></span>advanceToHourBoundary()</h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">void advanceToHourBoundary </td>
          <td>(</td>
          <td class="paramtype">void</td>          <td class="paramname"><span class="paramname"><em></em></span></td><td>)</td>
          <td></td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel static">static</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p>Advance minutes from current position to the next hour boundary (XX:00). </p>
<pre class="fragment">    Used in "fast sync" when the mechanical position is known from
    backup registers (not 00:00). If minutes are already at 0, does
    nothing. Otherwise advances (60 - currentMinutes) times to reach
    the next hour, which also increments the mechanical hour.

    After this function, the mechanical clock is at (H+1):00 and
    syncHours/syncMinutes can set the exact target.
</pre> 
<p class="definition">Definition at line <a class="el" href="clock__task_8c_source.html#l00270">270</a> of file <a class="el" href="clock__task_8c_source.html">clock_task.c</a>.</p>

<p class="reference">References <a class="el" href="clock__task_8c_source.html#l00118">clockAdvMinute()</a>, <a class="el" href="rtos__init_8h_source.html#l00039">DISP_EV_SYN_SRC_HOUR</a>, <a class="el" href="rtos__init_8c_source.html#l00027">displayTaskHandle</a>, and <a class="el" href="rtc__helpers_8c_source.html#l00051">getMechMinutes()</a>.</p>

<p class="reference">Referenced by <a class="el" href="clock__task_8c_source.html#l00322">clockTask()</a>.</p>

</div>
</div>
<a id="ae45fd19b5c3a9bf7e848bb0ebcdbb43d" name="ae45fd19b5c3a9bf7e848bb0ebcdbb43d"></a>
<h2 class="memtitle"><span class="permalink"><a href="#ae45fd19b5c3a9bf7e848bb0ebcdbb43d">&#9670;&#160;</a></span>clockTask()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void clockTask </td>
          <td>(</td>
          <td class="paramtype">void *</td>          <td class="paramname"><span class="paramname"><em>parameters</em></span></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>FreeRTOS task: mechanical clock synchronization and minute ticking. </p>
<pre class="fragment">    Manages the physical Solari Cifra 5 flip clock mechanism. Runs in
    three phases inside an outer while(1) loop:

    PHASE 1 — PRE-SYNC:
    On first boot (rtcInitOk=0, RTC never initialized), sends
    DISP_EV_FORCE_SETUP to trigger the setup wizard and blocks on
    xTaskNotifyWait until the user finishes setting the time.
    Then waits out any active silent period (checks every 60s).

    PHASE 2 — SYNC:
    Suspends buttonTask to prevent user interaction during sync.
    If mechanical position is 00:00 (unknown), runs sensor-based
    searchForZeroPosition(). Otherwise does a fast sync via
    advanceToHourBoundary(). Then reads RTC time and calls
    syncHours() + syncMinutes() to match the mechanical clock.
    Notifies displayTask with DISP_EV_SYN_END when complete.

    PHASE 3 — NORMAL OPERATION:
    Polls every CLOCK_UPDATE_INTERVAL (100ms). Compares mechanical
    minutes (from backup registers) to RTC minutes. When they differ,
    advances one minute flap using clockAdvMinute(slow=1).
    Monitors the hour sensor during advances — an unexpected hour
    transition indicates mechanical drift and triggers a full resync
    (breaks back to Phase 2).
    Also handles silent period entry/exit (exit triggers resync).

    xTaskNotifyWait(clearEntry, clearExit, &amp;value, timeout): blocks
    until a notification arrives or timeout. In Phase 1, uses
    portMAX_DELAY (infinite wait). In Phase 3, uses 100ms timeout
    for periodic polling.

    vTaskSuspend(handle): suspends another task. Used to disable
    buttonTask during sync. vTaskSuspend on an already-suspended
    task is a safe no-op.
</pre><dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">parameters</td><td>Cast to uint8_t: 0 = RTC not initialized (first boot), non-zero = RTC valid (normal boot / power cycle) </td></tr>
  </table>
  </dd>
</dl>

<p class="definition">Definition at line <a class="el" href="clock__task_8c_source.html#l00322">322</a> of file <a class="el" href="clock__task_8c_source.html">clock_task.c</a>.</p>

<p class="reference">References <a class="el" href="clock__task_8c_source.html#l00270">advanceToHourBoundary()</a>, <a class="el" href="rtos__init_8c_source.html#l00028">buttonTaskHandle</a>, <a class="el" href="rtos__init_8h_source.html#l00026">CLOCK_EV_NEW_TIME</a>, <a class="el" href="clock__task_8h_source.html#l00038">CLOCK_UPDATE_INTERVAL</a>, <a class="el" href="clock__task_8c_source.html#l00118">clockAdvMinute()</a>, <a class="el" href="rtos__init_8h_source.html#l00047">DISP_EV_ERR_MANY_SYNC</a>, <a class="el" href="rtos__init_8h_source.html#l00048">DISP_EV_FORCE_SETUP</a>, <a class="el" href="rtos__init_8h_source.html#l00043">DISP_EV_SYN_END</a>, <a class="el" href="rtos__init_8h_source.html#l00038">DISP_EV_SYN_START</a>, <a class="el" href="rtos__init_8c_source.html#l00027">displayTaskHandle</a>, <a class="el" href="rtc__helpers_8c_source.html#l00039">getMechHours()</a>, <a class="el" href="rtc__helpers_8c_source.html#l00051">getMechMinutes()</a>, <a class="el" href="rtos__init_8c_source.html#l00026">hrtcHandle</a>, <a class="el" href="rtc__helpers_8c_source.html#l00376">isInSilentPeriod()</a>, <a class="el" href="rtc__helpers_8c_source.html#l00113">resetMechPosition()</a>, <a class="el" href="rtc__helpers_8c_source.html#l00021">RTC_Date</a>, <a class="el" href="rtc__helpers_8c_source.html#l00020">RTC_Time</a>, <a class="el" href="clock__task_8c_source.html#l00173">searchForZeroPosition()</a>, <a class="el" href="main_8h_source.html#l00073">SNS_HOUR_GPIO_Port</a>, <a class="el" href="main_8h_source.html#l00072">SNS_HOUR_Pin</a>, <a class="el" href="clock__task_8c_source.html#l00225">syncHours()</a>, and <a class="el" href="clock__task_8c_source.html#l00249">syncMinutes()</a>.</p>

<p class="reference">Referenced by <a class="el" href="rtos__init_8c_source.html#l00077">createRTOS_Tasks()</a>.</p>

</div>
</div>
</div><!-- contents -->
</div><!-- doc-content -->
<div id="page-nav" class="page-nav-panel">
<div id="page-nav-resize-handle"></div>
<div id="page-nav-tree">
<div id="page-nav-contents">
</div><!-- page-nav-contents -->
</div><!-- page-nav-tree -->
</div><!-- page-nav -->
</div><!-- container -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="navelem"><a href="dir_c6310732a22f63c0c2fc5595561e68f1.html">Core</a></li><li class="navelem"><a href="dir_b596f468b52957496e4f78b80e029268.html">Src</a></li><li class="navelem"><a href="clock__task_8c.html">clock_task.c</a></li>
    <li class="footer">Generated by <a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.16.1 </li>
  </ul>
</div>
</body>
</html>
